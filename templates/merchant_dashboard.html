{% extends "base.html" %}
{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="flex items-start justify-between gap-4 flex-wrap">
  <div>
    <h1 class="text-2xl font-bold">Dashboard Comerciante</h1>
    <p class="text-slate-600">Administra tu negocio y tus publicaciones.</p>
  </div>

  <div class="flex gap-2 flex-wrap">
    <a href="/merchant/onboarding" class="px-3 py-2 rounded-lg bg-white border hover:bg-slate-100">Editar negocio</a>
    <a href="/listings/new" class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Nuevo lugar</a>
  </div>
</div>

{% if business %}
  <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
  </div>

  <div class="mt-6 bg-white border rounded-2xl p-6">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <div>
        <div class="font-semibold">Mis lugares publicados</div>
        <div class="text-sm text-slate-600">Solo tú puedes editarlos.</div>
      </div>
    </div>

    {% if my_listings and my_listings|length > 0 %}
      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for l in my_listings %}
          <div class="p-5 rounded-2xl border bg-white">
            <div class="text-xs text-slate-500">{{ l.route }} · <span class="capitalize">{{ l.category }}</span></div>
            <div class="text-lg font-semibold mt-1">{{ l.title }}</div>
            <div class="text-sm text-slate-700 mt-2">{{ l.short_desc }}</div>

            <div class="mt-4 flex items-center justify-between">
              <div class="text-sm font-bold">${{ "%.2f"|format(l.price_usd) }}</div>
              <div class="text-xs text-slate-500">{{ l.duration_min }} min</div>
            </div>

            <div class="mt-4 flex gap-2 flex-wrap">
              <a href="/listings/{{ l.id }}" class="px-3 py-2 rounded-lg bg-white border hover:bg-slate-100">Ver</a>
              <a href="/listings/{{ l.id }}/edit" class="px-3 py-2 rounded-lg bg-white border hover:bg-slate-100">Editar</a>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="mt-4 text-sm text-slate-600">
        Aún no publicas lugares. Crea el primero y aparece en el catálogo.
      </div>
    {% endif %}
  </div>
{% else %}
  <div class="mt-6 p-5 rounded-2xl border bg-amber-50 text-amber-900">
    No tienes negocio registrado. Completa onboarding para aparecer en el mapa.
    <div class="mt-3">
      <a href="/merchant/onboarding" class="px-4 py-2 rounded-lg bg-emerald-700 text-white hover:bg-emerald-800">
        Ir a onboarding
      </a>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/static/map.js"></script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const biz = {{ business_json | safe }};
    if (!biz || !biz.lat) return;

    window.CRMaps.initPublicMap({
      mapId: "bizMap",
      markers: [biz],
      startLat: biz.lat,
      startLng: biz.lng,
      zoom: 14
    });
  });
</script>
{% endblock %}
