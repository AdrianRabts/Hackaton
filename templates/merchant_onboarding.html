{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="flex items-start justify-between gap-4 flex-wrap">
    <div>
      <h1 class="text-2xl font-bold">Onboarding del negocio</h1>
      <p class="text-slate-600">Registra tu negocio y coloca el pin para aparecer en el mapa.</p>
    </div>
    <!-- Quitado: Dashboard aquí estaba duplicado con el navbar -->
  </div>

  {% if error %}
    <div class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-900 text-sm">
      {{ error }}
    </div>
  {% endif %}

  <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 bg-white border rounded-2xl p-6">
      <form method="post" action="/merchant/onboarding" class="grid gap-4">
        <div>
          <label class="text-sm text-slate-600">Nombre del negocio</label>
          <input
            name="name"
            required
            value="{{ prefill_name if prefill_name else '' }}"
            class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-200"
            placeholder="Ej: Artesanías Don Pepe"
          />
        </div>

        <div>
          <label class="text-sm text-slate-600">Ruta principal</label>
          <select
            name="route"
            class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-200"
            required
          >
            <option value="Ruta Spondylus / Montañita" {% if prefill_route=="Ruta Spondylus / Montañita" %}selected{% endif %}>
              Ruta Spondylus / Montañita
            </option>
            <option value="Cuenca" {% if prefill_route=="Cuenca" %}selected{% endif %}>Cuenca</option>
            <option value="Tena" {% if prefill_route=="Tena" %}selected{% endif %}>Tena</option>
          </select>
        </div>

        <div>
          <label class="text-sm text-slate-600">Descripción (opcional)</label>
          <textarea
            name="description"
            rows="3"
            class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-200"
            placeholder="Qué ofreces, por qué es auténtico, qué lo hace especial..."
          ></textarea>
        </div>

        <div>
          <label class="text-sm text-slate-600">Dirección</label>
          <input
            name="address"
            required
            class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-200"
            placeholder="Ej: Malecón, frente al parque..."
          />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm text-slate-600">WhatsApp</label>
            <input
              name="phone_whatsapp"
              class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-200"
              placeholder="+5939..."
            />
          </div>
          <div>
            <label class="text-sm text-slate-600">Maps URL</label>
            <input
              name="maps_url"
              type="url"
              class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-200"
              placeholder="https://maps..."
            />
          </div>
          <div>
            <label class="text-sm text-slate-600">TikTok URL</label>
            <input
              name="tiktok_url"
              type="url"
              class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-200"
              placeholder="https://tiktok..."
            />
          </div>
        </div>

        <input id="lat" name="lat" type="hidden" />
        <input id="lng" name="lng" type="hidden" />

        <div class="flex items-center justify-between flex-wrap gap-3 pt-2">
          <div class="text-xs text-slate-500">Tip: click en el mapa o arrastra el pin.</div>
          <button class="px-4 py-2 rounded-lg bg-emerald-700 text-white hover:bg-emerald-800">
            Guardar negocio
          </button>
        </div>
      </form>
    </div>

    <div class="bg-white border rounded-2xl p-6">
      <div class="font-semibold">Ubicación</div>
      <p class="text-sm text-slate-600 mt-1">Coloca el pin donde está tu negocio.</p>
      <div id="pickMap" class="mt-4 rounded-xl border" style="height: 360px;"></div>

      <div class="mt-3 text-xs text-slate-500">
        Coordenadas: <span class="font-semibold" id="coordPreview">—</span>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/static/map.js"></script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const startLat = Number("{{ default_lat }}");
    const startLng = Number("{{ default_lng }}");

    window.CRMaps.initPickerMap({
      mapId: "pickMap",
      latInputId: "lat",
      lngInputId: "lng",
      startLat,
      startLng,
      zoom: 6
    });

    const latEl = document.getElementById("lat");
    const lngEl = document.getElementById("lng");
    const prev = document.getElementById("coordPreview");

    const updatePreview = () => {
      if (!latEl.value || !lngEl.value) {
        prev.textContent = "—";
        return;
      }
      prev.textContent = `${Number(latEl.value).toFixed(6)}, ${Number(lngEl.value).toFixed(6)}`;
    };

    // Actualiza cuando cambian (y un primer refresh)
    ["change", "input"].forEach(evt => {
      latEl.addEventListener(evt, updatePreview);
      lngEl.addEventListener(evt, updatePreview);
    });
    updatePreview();

    // Por si tu map.js setea valores sin disparar eventos:
    setInterval(updatePreview, 500);
  });
</script>
{% endblock %}
